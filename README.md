# イカの体色表現シェーダ
![Thumbnail_20K1023_長谷川紘大](https://github.com/user-attachments/assets/b8a0c500-24b2-44af-823b-4783752e251c)

## 概要
イカの体色変化は, 色素成分である色素胞と, 構造色成分である虹色素胞がそれぞれ変化することで実現される. 

本シェーダは, 色素胞と虹色素胞による体色変化を含む, イカの体表色を表現するシェーダである. 

## 動作環境:
Unity 2022.3.22f1

レンダリングパイプライン: HDRP

シェーダ作成ツール: Shader Graph(一部 HLSL, C#スクリプトを使用)

## 実行方法:
Asset内に2つのシーンを用意したので好きな方を実行する.
scene1は1体に注目するシーン, scene2は複数体を表示するシーン(サムネ画像など). とりあえずはscene1の実行を推奨.

Material内に2つのマテリアルを用意したので, 好きな方をドラッグアンドドロップでイカモデルに適用する. 
マテリアルを選択した状態で, Unity画面右側のInspectorにある項目をいじってもらうことで, シェーダの調整が可能. 

SMaterial_animationは, アニメーションを組み込んだシェーダ(Squid_animation)に対応し, イカの動的な体色変化を表現することが可能(Always RefreshをONにしてないと通常画面では確認できないので注意)

SMaterial_settingは, アニメーションを省き手動でのパラメータ調整を可能にしたシェーダ(Squid_setting)に対応する

各調整項目, パラメータについては以下に記載していく. 

## 調整項目, パラメータ
### SMaterial_animation
 アニメーションマテリアルには調整項目が10個ある
![anim_insp](https://github.com/user-attachments/assets/6b89e99b-4023-4838-8f32-2ba8614cf669)

#### gamma
構造色の強度を調整できる. 
構造色テクスチャに対しガンマ補正する際の乗数に対応. 
#### IriS
虹色素胞モデルの大きさを指定可能. 
色素胞モデルの大きさに対応させているため基本調整不要. 
#### smooth, metal
モデルの質感がどのくらい滑らかか(smooth), 金属質か(metallic)を指定可能. 
#### Transparency, Transparency_White
シェーダの透明度を指定可能. 
Transparencyは色素胞と虹色素胞モデル部分の透明度に, Transparency_Whiteはそれ以外の白色部分の透明度に対応. 
#### time_show～irido
まず, 設定しているアニメーションについて説明する. 

色素胞モデルについて, 色素胞による4つの体色パターン(Clear, All Dark, Ring, Dorsal Stripe)を順に表示し, それぞれの体色パターンを膨張収縮によりスムーズに切り替える, というアニメーションを付けている. 
ここで, time_showは各体色パターンの表示時間, time_changeは体色パターンの切り替えに要する時間, time_delayはスタート時間の変化(初期の体色パターンを変更可能)にそれぞれ対応する. 
ただし, time_changeについては実データより定めた値のため基本調整不要. 

虹色素胞モデルについて, 膜厚パラメータD(後述)を0-1の間で変化させ続けるアニメーションを付けている. 
ここで, time_iridoはDが0→1, 1→0に変化するのにかかる時間に対応. 

### SMaterial_setting()
セッティングマテリアルには調整項目が13個あるが, 前項に重複するものは省いて紹介する. 
![set_insp](https://github.com/user-attachments/assets/e0628276-dcfd-4b37-b199-c24f34158ebe)

#### Center～Yellow
それぞれ対応する色の色素胞の膨張収縮を制御可能. 
0が収縮時, 1が膨張時に該当し, 最大と最小で半径は10倍異なるようにしている. 
#### Ring, DorsalStripe
それぞれ対応する模様部分に位置する色素胞の膨張収縮を制御可能. 
0が収縮時, 1が膨張時に該当し, 最大と最小で半径は10倍異なるようにしている. 
#### D
虹色素胞モデルにおける膜厚の変化を制御する値. 
膜厚は, 0のときに最小, 1のときに最大となるようにしている. 
見た目の変化としては, 0に近いほど短波長帯の色(青や紫), 1に近いほど長波長隊の色(赤やオレンジ)が確認できる. 

## 構造色ルックアップテーブル(LUT)
### LUTの生成
まず, creatLUTフォルダ内のSquid_LUT.pyを開きmain_myMultilayer_3D()を実行し, CSVを生成(この作業はUnityでなくpythonで行う). 
ちなみに, main_myMultilayer_2D()では, 膜厚パラメータDの値を固定した2D画像を得ることができる. 
生成したCSVをUnityデータのcsvフォルダ内に移動させる. 
 次に, Hierarchy内のCreate 3DTextureオブジェクトを有効にし, そのinspectorにあるスクリプトも有効にする↓
![スクリーンショット 2025-03-13 112836](https://github.com/user-attachments/assets/279e95c6-2a67-489e-8e25-93ca7a28fcc2)

ここで, 対応しているStrucmap_create_usecsvを開き(クリックで開ける), csvの場所とLUTの保存先を指定する. 
その後, 保存しUnityに戻り, 実行する(1番上の▷を押す)と3DLUTが生成される. 

### 使用するLUTについて
 LUTフォルダ内には様々なLUTが保存されているが, 使用するのはstrucmap_m3d8-N8-new2とする. 
 ![スクリーンショット 2025-03-13 120154](https://github.com/user-attachments/assets/bd5583a8-b73f-4590-8d03-20d567074be5)
 
これは, dL=120-50nm, dH=160-80nmかつ平均値dL=95nm,dH=120nmを通るようガンマ補正し, タンパク質層の層数を8枚としたものに該当する(詳細は論文へ). 
また, シェーダ内でLUTを適用する際は, wrap modeをclampにする必要があるが, clamp時に起きる本LUT以外はclamp時にノイズが出てしまうので注意. 

## オブジェクト
イカのモデル以外のHierarchyにあるオブジェクトを説明. 

### Box Volume: Water
海中表現のために置いた青色のフォグ. 
### Canvas
有効にすると, パラメータDの値をUIとして表示. 
### Camera
複数あり, それぞれに別のアニメーションが付いている. 

## 最後に
シェーダの中身については, 理解しづらい部分もあると思うため, 何かあれば連絡ください(返答は遅いかもしれません). 
また, いくつか改善したいと考えていた部分もあるため, 今後のために記しておきます. 
### シェーダのスクリプト化
私はプログラミングに苦手意識があったため, Shader Graphを利用したが, かえって難解で一見では理解しづらいものとなってしまった. 
そのため, 同内容をスクリプト化する必要性を感じている. 

### ジッタの改善
シェーダの特性上, 出力した動画でジッタが目立つことがある(特にAll Dark時)
Post Process機能でブラーをかけることで解決を目指していたが, 実装まで至らなかった. 
情け程度にカメラにアンチエイリアス機能(FXAA)を付けている. 

### モデルのアニメーション
本データでは, カメラにアニメーションを付けているが, イカのモデル自体にアニメーションを付けていない. 
複数の触腕にアニメーションを付けるのは難しいと思うが挑戦してみてほしい. 
また, 使用したモデルは元からリグ付けされているので利用できるかもしれない(https://www.blenderkit.com/get-blenderkit/a1f3d3fa-c3d6-43d6-a450-c3b9bcec8937/). 
